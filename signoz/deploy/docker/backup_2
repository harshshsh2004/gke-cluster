#cat otel-collector-config.yaml 
connectors:
  signozmeter:
    metrics_flush_interval: 60s
    dimensions:
      - name: service.name
      - name: deployment.environment
      - name: host.name

receivers:
  filelog:
    include: [ "/var/lib/docker/containers//.log" ]
    start_at: end
    include_file_path: true
    include_file_name: false
    operators:
      # 1. Parse the Docker JSON wrapper
      - type: json_parser
        id: parser-docker
        timestamp:
          parse_from: attributes.time
          layout: '%Y-%m-%dT%H:%M:%S.%LZ'
          
      # 2. Extract the actual log message from the "log" field
      - type: move
        from: attributes.log
        to: body
        
      # 3. (Optional) Filter: Only keep logs containing specific keywords
      #    Remove this block if you want to see EVERYTHING.
    #  - type: filter
    #    id: filter-noise
    #    expr: 'not (body matches "nginx-frontend")'
    #    drop_ratio: 1.0 # This drops everything NOT matching "nginx-frontend"
  
  
  
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        cors:
          allowed_origins:
            - "http://*"
            - "https://*"
          allowed_headers: ["*"]
        endpoint: 0.0.0.0:4318
  prometheus:
    config:
      global:
        scrape_interval: 60s
      scrape_configs:
        - job_name: otel-collector
          static_configs:
          - targets:
              - localhost:8888
            labels:
              job_name: otel-collector

processors:
  batch:
    send_batch_size: 10000
    send_batch_max_size: 11000
    timeout: 10s
  batch/meter:
    send_batch_max_size: 25000
    send_batch_size: 20000
    timeout: 1s
  resourcedetection:
    detectors: [env, system]
    timeout: 2s
  signozspanmetrics/delta:
    metrics_exporter: signozclickhousemetrics
    metrics_flush_interval: 60s
    dimensions_cache_size: 100000
    aggregation_temporality: AGGREGATION_TEMPORALITY_DELTA
    enable_exp_histogram: true
    dimensions:
      - name: service.namespace
        default: default
      - name: deployment.environment
        default: default
      - name: signoz.collector.id
      - name: service.version
      - name: container.name
      - name: host.name

exporters:
  clickhousetraces:
    datasource: tcp://clickhouse:9000/signoz_traces
    use_new_schema: true
  signozclickhousemetrics:
    dsn: tcp://clickhouse:9000/signoz_metrics
  clickhouselogsexporter:
    dsn: tcp://clickhouse:9000/signoz_logs
    timeout: 10s
    use_new_schema: true
  signozclickhousemeter:
    dsn: tcp://clickhouse:9000/signoz_meter
    timeout: 45s
    sending_queue:
      enabled: false

extensions:
  health_check:
    endpoint: 0.0.0.0:13133
  pprof:
    endpoint: 0.0.0.0:1777

service:
  telemetry:
    logs:
      encoding: json
  extensions: [health_check, pprof]
  pipelines:
    traces:
      receivers: [otlp]
      processors: [signozspanmetrics/delta, batch]
      # FIX: Added signozmeter here
      exporters: [clickhousetraces, signozmeter]
    metrics:
      receivers: [otlp]
      processors: [batch]
      # FIX: Added signozmeter here
      exporters: [signozclickhousemetrics, signozmeter]
    metrics/prometheus:
      receivers: [prometheus]
      processors: [batch]
      # FIX: Added signozmeter here
      exporters: [signozclickhousemetrics, signozmeter]
    logs:
      receivers: [otlp, filelog]
      processors: [batch]
      # FIX: Added signozmeter here
      exporters: [clickhouselogsexporter, signozmeter]
    metrics/meter:
      receivers: [signozmeter]
      processors: [batch/meter]
      exporters: [signozclickhousemeter]
